<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ Open-Source –ø—Ä–æ–µ–∫—Ç–æ–≤</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>–ü–æ–∏—Å–∫ Open-Source –ø—Ä–æ–µ–∫—Ç–æ–≤ GitHub</h1>
        
        <div class="search-box">
            <input type="text" id="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞...">
            <button onclick="search()">–ò—Å–∫–∞—Ç—å</button>
            <button onclick="refreshData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <div class="filters">
            <select id="language-filter" onchange="applyFilter()">
                <option value="">–í—Å–µ —è–∑—ã–∫–∏</option>
                <option value="JavaScript">JavaScript</option>
                <option value="Python">Python</option>
                <option value="Java">Java</option>
                <option value="TypeScript">TypeScript</option>
                <option value="Go">Go</option>
            </select>
            
            <select id="sort-filter" onchange="applyFilter()">
                <option value="stars">–ü–æ –∑–≤—ë–∑–¥–∞–º</option>
                <option value="forks">–ü–æ —Ñ–æ—Ä–∫–∞–º</option>
                <option value="updated">–ü–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é</option>
            </select>
        </div>

        <div id="loading" style="display: none;">
            <div class="loader"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <div id="error" style="display: none;">
            <p class="error-message"></p>
            <button onclick="retry()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        </div>

        <div id="empty" style="display: none;">
            <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.</p>
        </div>

        <div id="results"></div>

        <div class="pagination" id="pagination" style="display: none;">
            <button id="prev-btn" onclick="prevPage()">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
            <span id="page-info"></span>
            <button id="next-btn" onclick="nextPage()">–°–ª–µ–¥—É—é—â–∞—è</button>
        </div>

        <div id="modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <div id="modal-body"></div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        var currentPage = 1;
        var totalPages = 1;
        var currentQuery = '';
        var allResults = [];
        var controller = null;
        var cache = {};
        var retryCount = 0;

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞
        function search() {
            var input = document.getElementById('search-input');
            currentQuery = input.value;
            currentPage = 1;
            
            if (!currentQuery) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞!');
                return;
            }
            
            if (controller) {
                controller.abort();
            }
            
            loadData(false);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData(ignoreCache) {
            var loading = document.getElementById('loading');
            var error = document.getElementById('error');
            var empty = document.getElementById('empty');
            var results = document.getElementById('results');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            empty.style.display = 'none';
            results.innerHTML = '';
            
            var cacheKey = currentQuery + '_' + currentPage;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
            if (!ignoreCache && cache[cacheKey]) {
                var cacheData = cache[cacheKey];
                var now = new Date().getTime();
                if (now - cacheData.timestamp < 300000) { // 5 –º–∏–Ω—É—Ç
                    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à');
                    displayResults(cacheData.data);
                    loading.style.display = 'none';
                    return;
                }
            }
            
            controller = new AbortController();
            
            try {
                var data = await fetchWithRetry(
                    'https://api.github.com/search/repositories?q=' + currentQuery + '&page=' + currentPage + '&per_page=10',
                    {
                        retries: 3,
                        backoffMs: 1000,
                        timeoutMs: 10000,
                        signal: controller.signal
                    }
                );
                
                if (data.items.length === 0) {
                    empty.style.display = 'block';
                } else {
                    allResults = data.items;
                    totalPages = Math.ceil(data.total_count / 10);
                    if (totalPages > 100) totalPages = 100;
                    
                    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
                    cache[cacheKey] = {
                        data: data,
                        timestamp: new Date().getTime()
                    };
                    
                    displayResults(data);
                }
                
                retryCount = 0;
            } catch (err) {
                if (err.name !== 'AbortError') {
                    error.style.display = 'block';
                    document.querySelector('.error-message').textContent = '–û—à–∏–±–∫–∞: ' + err.message;
                }
            } finally {
                loading.style.display = 'none';
            }
        }

        // Fetch —Å —Ä–µ—Ç—Ä–∞—è–º–∏
        async function fetchWithRetry(url, options) {
            var retries = options.retries || 3;
            var backoffMs = options.backoffMs || 1000;
            var timeoutMs = options.timeoutMs || 5000;
            
            for (var i = 0; i <= retries; i++) {
                try {
                    var response = await fetchWithTimeout(url, timeoutMs, options.signal);
                    
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    
                    return await response.json();
                } catch (err) {
                    if (err.name === 'AbortError') {
                        throw err;
                    }
                    
                    if (i === retries) {
                        throw err;
                    }
                    
                    console.log('–ü–æ–ø—ã—Ç–∫–∞ ' + (i + 1) + ' –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ' + backoffMs + '–º—Å');
                    await sleep(backoffMs);
                    backoffMs = backoffMs * 2;
                }
            }
        }

        // Fetch —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        function fetchWithTimeout(url, timeout, signal) {
            return new Promise(function(resolve, reject) {
                var timer = setTimeout(function() {
                    reject(new Error('Timeout'));
                }, timeout);
                
                fetch(url, { signal: signal })
                    .then(function(response) {
                        clearTimeout(timer);
                        resolve(response);
                    })
                    .catch(function(err) {
                        clearTimeout(timer);
                        reject(err);
                    });
            });
        }

        // Sleep —Ñ—É–Ω–∫—Ü–∏—è
        function sleep(ms) {
            return new Promise(function(resolve) {
                setTimeout(resolve, ms);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResults(data) {
            var results = document.getElementById('results');
            var pagination = document.getElementById('pagination');
            
            results.innerHTML = '';
            
            data.items.forEach(function(repo) {
                var card = document.createElement('div');
                card.className = 'card';
                card.onclick = function() {
                    showDetails(repo.id);
                };
                
                card.innerHTML = '<img src="' + repo.owner.avatar_url + '" alt="Avatar">' +
                    '<h3>' + repo.name + '</h3>' +
                    '<p>' + (repo.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è') + '</p>' +
                    '<div class="stats">' +
                    '<span>‚≠ê ' + repo.stargazers_count + '</span>' +
                    '<span>üç¥ ' + repo.forks_count + '</span>' +
                    '<span>' + (repo.language || 'N/A') + '</span>' +
                    '</div>';
                
                results.appendChild(card);
            });
            
            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                document.getElementById('page-info').textContent = '–°—Ç—Ä–∞–Ω–∏—Ü–∞ ' + currentPage + ' –∏–∑ ' + totalPages;
                document.getElementById('prev-btn').disabled = currentPage === 1;
                document.getElementById('next-btn').disabled = currentPage === totalPages;
            } else {
                pagination.style.display = 'none';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏
        async function showDetails(repoId) {
            var repo = allResults.find(function(r) { return r.id === repoId; });
            if (!repo) return;
            
            var modal = document.getElementById('modal');
            var modalBody = document.getElementById('modal-body');
            
            modalBody.innerHTML = '<div class="loader"></div>';
            modal.style.display = 'block';
            
            try {
                var response = await fetch(repo.url);
                var details = await response.json();
                
                var contributorsResponse = await fetch(details.contributors_url + '?per_page=5');
                var contributors = await contributorsResponse.json();
                
                var html = '<h2>' + details.name + '</h2>' +
                    '<img src="' + details.owner.avatar_url + '" alt="Owner avatar" style="width: 100px; height: 100px; border-radius: 50%;">' +
                    '<p>' + (details.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è') + '</p>' +
                    '<p><strong>–Ø–∑—ã–∫:</strong> ' + (details.language || 'N/A') + '</p>' +
                    '<p><strong>–ó–≤—ë–∑–¥—ã:</strong> ' + details.stargazers_count + '</p>' +
                    '<p><strong>–§–æ—Ä–∫–∏:</strong> ' + details.forks_count + '</p>' +
                    '<p><strong>–û—Ç–∫—Ä—ã—Ç—ã–µ Issues:</strong> ' + details.open_issues_count + '</p>' +
                    '<p><strong>–°–æ–∑–¥–∞–Ω:</strong> ' + new Date(details.created_at).toLocaleDateString() + '</p>' +
                    '<p><strong>–û–±–Ω–æ–≤–ª—ë–Ω:</strong> ' + new Date(details.updated_at).toLocaleDateString() + '</p>' +
                    '<p><a href="' + details.html_url + '" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ GitHub</a></p>';
                
                if (contributors && contributors.length > 0) {
                    html += '<h3>–¢–æ–ø –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä—ã:</h3><div class="contributors">';
                    contributors.forEach(function(c) {
                        html += '<div><img src="' + c.avatar_url + '" alt="Contributor avatar" style="width: 50px; height: 50px; border-radius: 50%;"><br>' + c.login + '</div>';
                    });
                    html += '</div>';
                }
                
                modalBody.innerHTML = html;
            } catch (err) {
                modalBody.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π: ' + err.message + '</p>';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        function refreshData() {
            if (!currentQuery) {
                search();
                return;
            }
            loadData(true);
        }

        // –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
        function retry() {
            loadData(false);
        }

        // –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadData(false);
            }
        }

        // –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadData(false);
            }
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
        function applyFilter() {
            var language = document.getElementById('language-filter').value;
            var sort = document.getElementById('sort-filter').value;
            
            var query = currentQuery;
            if (language) {
                query += ' language:' + language;
            }
            
            currentQuery = query;
            currentPage = 1;
            loadData(true);
        }

        // Enter –¥–ª—è –ø–æ–∏—Å–∫–∞
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    search();
                }
            });
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ—ë
        window.onclick = function(event) {
            var modal = document.getElementById('modal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
