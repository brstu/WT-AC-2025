# Лабораторная работа №5: REST API для отзывов о местах с модерацией

<p align="center">Министерство образования Республики Беларусь</p>
<p align="center">Учреждение образования</p>
<p align="center">"Брестский Государственный технический университет"</p>
<p align="center">Кафедра ИИТ</p>
<br><br><br><br><br><br>
<p align="center"><strong>Лабораторная работа №5</strong></p>
<p align="center"><strong>По дисциплине:</strong> "Веб-технологии"</p>
<p align="center"><strong>Тема:</strong> "Сервис отзывов о местах с модерацией"</p>
<br><br><br><br><br><br>
<p align="right"><strong>Выполнил:</strong></p>
<p align="right">Студент 4 курса</p>
<p align="right">Группы АС-63</p>
<p align="right">Тунчик А.Д.</p>
<p align="right"><strong>Проверил:</strong></p>
<p align="right">Несюк А. Н.</p>
<br><br><br><br><br>
<p align="center"><strong>Брест 2025</strong></p>

## Вариант 21. Сервис отзывов о местах с модерацией

## Описание проекта

Профессиональное серверное REST API на Express.js для управления отзывами о местах с системой аутентификации, модерации и ролевой моделью доступа. Проект реализует полный CRUD-функционал с JWT аутентификацией, валидацией данных, обработкой ошибок, пагинацией, поиском и фильтрацией.

## Цели

- Разработать REST API для управления отзывами о местах с системой модерации
- Реализовать полноценную аутентификацию на базе JWT с refresh-токенами
- Обеспечить ролевой доступ (пользователь/администратор) к данным
- Реализовать систему модерации отзывов администраторами
- Обеспечить полный CRUD с валидацией и обработкой ошибок
- Реализовать поиск, фильтрацию и пагинацию результатов
- Интегрировать базу данных SQLite через ORM Prisma

## Тема

API отзывов о местах на Express.js с аутентификацией JWT, системой модерации и ролевым доступом, с валидацией через Zod и ORM Prisma.

## Реализованные компоненты

- **Модели данных**: `prisma/schema.prisma`
- **Маршруты API**: `src/routes.js`
- **Middleware**: `src/middlewares.js` (аутентификация, обработка ошибок, rate limiting)
- **Валидация**: `src/validators.js` (Zod схемы)
- **База данных**: `src/database.js` (подключение Prisma)
- **Тестовые данные**: `src/seed.js`
- **Точка входа**: `src/server.js`
- **Тесты**: `tests/` (полный набор тестов)

## Доступность

- **Сервер**: http://localhost:3000
- **Health check**: http://localhost:3000/health
- **База URL API**: http://localhost:3000/api
- **Формат ответов**: JSON
- **CORS**: включен для http://localhost:3000

## Особенности и реализованные требования

### Основной функционал

- ✅ **Полный CRUD** для отзывов о местах
- ✅ **JWT аутентификация** с access и refresh токенами
- ✅ **Ролевая система** (USER/ADMIN) с разграничением прав доступа
- ✅ **Система модерации** отзывов администраторами
- ✅ **Валидация данных** с помощью Zod
- ✅ **Централизованная обработка ошибок** с кастомным классом ApiError
- ✅ **Пагинация** с метаданными (total, limit, offset, hasMore)
- ✅ **Поиск и фильтрация** по статусу, тексту, пользователю
- ✅ **Защита маршрутов** middleware аутентификации
- ✅ **Rate limiting** для защиты от DoS атак
- ✅ **Безопасность**: helmet, CORS, лимит размера тела запроса

### Архитектура

- **Модульная структура**: разделение ответственности
- **ORM Prisma**: типобезопасная работа с БД
- **SQLite**: легковесная файловая БД
- **Миграции**: автоматическое создание схемы БД
- **Чистый код**: следование best practices
- **Тестирование**: полный набор unit-тестов

## API Эндпоинты

### Аутентификация (`/api/auth/*`)

| Метод | URL                | Описание                        | Доступ              |
|-------|--------------------|---------------------------------|---------------------|
| POST  | `/api/auth/signup` | Регистрация нового пользователя | Все                 |
| POST  | `/api/auth/login`  | Вход в систему                  | Все                 |
| POST  | `/api/auth/refresh`| Обновление access токена        | Все                 |
| GET   | `/api/auth/me`     | Получение текущего пользователя | Аутентифицированные |

### Отзывы (`/api/reviews/*`)

| Метод | URL                | Описание                 | Доступ             |
|-------|--------------------|--------------------------|--------------------|
| POST  | `/api/reviews`     | Создание отзыва          | USER, ADMIN        |
| GET   | `/api/reviews`     | Получение списка отзывов | USER, ADMIN        |
| GET   | `/api/reviews/:id` | Получение отзыва по ID   | USER, ADMIN        |
| PUT   | `/api/reviews/:id` | Обновление отзыва        | Владелец или ADMIN |
| DELETE| `/api/reviews/:id` | Удаление отзыва          | Владелец или ADMIN |

### Модерация (`/api/reviews/*/moderate`)

| Метод | URL                         | Описание         | Доступ       |
|-------|-----------------------------|------------------|--------      |
| PATCH | `/api/reviews/:id/moderate` | Модерация отзыва | Только ADMIN |

### Админ-панель (`/api/admin/*`)

| Метод | URL                | Описание           | Доступ       |
|-------|--------------------|--------------------|--------------|
| GET   | `/api/admin/stats` | Статистика системы | Только ADMIN |

#### Параметры запроса (GET `/api/reviews`)

- `status` — фильтр по статусу (PENDING, APPROVED, REJECTED)
- `userOnly` — только мои отзывы (true/false)
- `search` — поиск по названию места или описанию
- `limit` — количество элементов (по умолчанию 20)
- `offset` — смещение для пагинации (по умолчанию 0)

## Модели данных

### Пользователь (User)

```json
{
  "id": "clxyz...",
  "email": "user@example.com",
  "username": "john_doe",
  "role": "USER",
  "avatar": "https://example.com/avatar.jpg",
  "createdAt": "2024-01-15T10:00:00.000Z",
  "updatedAt": "2024-01-15T10:00:00.000Z"
}
```

### Отзыв (Review)

```json
{
  "id": "clyza...",
  "placeName": "Кафе 'Уют'",
  "description": "Отличное место с вкусным кофе...",
  "rating": 4.5,
  "location": "ул. Центральная, 10",
  "imageUrl": "https://example.com/photo.jpg",
  "tags": ["кафе", "кофе", "wifi"],
  "status": "APPROVED",
  "moderatedBy": "clxyz...",
  "moderatedAt": "2024-01-16T14:30:00.000Z",
  "rejectionReason": null,
  "userId": "clxyz...",
  "createdAt": "2024-01-15T10:00:00.000Z",
  "updatedAt": "2024-01-16T14:30:00.000Z"
}
```

## Примеры запросов

### Регистрация пользователя

```bash
POST http://localhost:3000/api/auth/signup
Content-Type: application/json

{
  "email": "user@example.com",
  "username": "john_doe",
  "password": "Test123!"
}
```

### Вход в систему

```bash
POST http://localhost:3000/api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "Test123!"
}
```

### Создание отзыва

```bash
POST http://localhost:3000/api/reviews
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "placeName": "Кафе 'Уют'",
  "description": "Отличное место с вкусным кофе и приятной атмосферой",
  "rating": 4.5,
  "location": "ул. Центральная, 10",
  "tags": ["кафе", "кофе", "wifi"]
}
```

### Получение отзывов с фильтрацией

```bash
GET http://localhost:3000/api/reviews?status=APPROVED&limit=10&offset=0
Authorization: Bearer {access_token}
```

### Модерация отзыва (админ)

```bash
PATCH http://localhost:3000/api/reviews/{review_id}/moderate
Authorization: Bearer {admin_access_token}
Content-Type: application/json

{
  "status": "APPROVED",
  "rejectionReason": null
}
```

## Технологии и зависимости

- **express** — веб-фреймворк
- **@prisma/client** — ORM для работы с БД
- **prisma** — инструменты миграций и генерации
- **sqlite3** — движок базы данных
- **jsonwebtoken** — JWT аутентификация
- **bcryptjs** — хеширование паролей
- **zod** — валидация схем данных
- **cors** — поддержка CORS
- **helmet** — безопасность HTTP-заголовков
- **express-rate-limit** — ограничение частоты запросов
- **morgan** — логирование HTTP-запросов
- **nodemon** (dev) — автоперезагрузка сервера
- **jest** (dev) — фреймворк для тестирования
- **supertest** (dev) — тестирование HTTP запросов

## Особенности реализации

1. **Безопасность**:
   - Хеширование паролей с bcryptjs
   - JWT токены с expires и refresh механикой
   - Защита от XSS и других атак через helmet
   - Rate limiting для защиты от брут-форса
   - Лимит размера тела запроса

2. **Валидация**:
   - Полная валидация всех входных данных через Zod
   - Кастомные сообщения об ошибках на русском языке
   - Валидация query параметров

3. **База данных**:
   - Использование Prisma ORM для типобезопасности
   - SQLite для простоты развертывания
   - Автоматические миграции
   - Связи между таблицами с каскадным удалением

4. **Архитектура**:
   - Централизованная обработка ошибок
   - Модульная структура кода
   - Middleware для аутентификации и авторизации
   - Четкое разделение ответственности

5. **Тестирование**:
   - Полный набор unit-тестов
   - Тестирование всех основных сценариев
   - Изолированная тестовая БД
   - Покрытие аутентификации, CRUD и модерации

## Инструкция по запуску

```bash
# 1. Клонировать репозиторий
git clone [repository-url]
cd places-reviews-api

# 2. Установить зависимости
npm install

# 3. Сгенерировать Prisma клиент
npm run prisma:generate

# 4. Запустить миграции (создаст БД)
npm run prisma:migrate

# 5. Заполнить БД тестовыми данными
npm run seed

# 6. Запустить сервер в режиме разработки
npm run dev

# 7. Запустить тесты
npm test
```

## Статусы отзывов

- **PENDING** — ожидает модерации (виден только автору и админам)
- **APPROVED** — одобрен администратором (виден всем пользователям)
- **REJECTED** — отклонен администратором (виден только автору и админам)

## Права доступа

## Обычный пользователь (USER)

- Может создавать, читать, обновлять и удалять СВОИ отзывы
- Видит только СВОИ отзывы и ОДОБРЕННЫЕ отзывы других пользователей
- Не может модерировать отзывы

## Администратор (ADMIN)

- Может выполнять все действия пользователя
- Видит ВСЕ отзывы (включая PENDING и REJECTED)
- Может модерировать отзывы (одобрять/отклонять)
- Имеет доступ к административной статистике

## Структура проекта

```
places-reviews-api/
├── prisma/              # Схема БД и миграции
├── src/                 # Исходный код
│   ├── server.js       # Точка входа
│   ├── database.js     # Подключение к БД
│   ├── routes.js       # Маршруты API
│   ├── middlewares.js  # Middleware функции
│   ├── validators.js   # Валидация данных
│   └── seed.js        # Тестовые данные
├── tests/              # Тесты
│   ├── setup.js       # Настройка тестов
│   ├── auth_test.js   # Тесты аутентификации
│   ├── reviews_test.js # Тесты отзывов
│   ├── admin_test.js  # Тесты админ-панели
│   └── health_test.js # Тесты health check
├── package.json       # Зависимости
├── .gitignore        # Исключения Git
└── README.md         # Документация
```

## Ссылка на проект

[https://github.com/Stis25/Web_Task06.git](https://github.com/Stis25/Web_Task06.git)
