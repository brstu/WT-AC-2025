/**
 * Клиент для загрузки новостей с кэшированием и фильтрацией
 * @module НовостнойКлиент
 */

'use strict';

// Русскоязычные новости (заглушка вместо API)
const РУССКИЕ_НОВОСТИ = [
    {
        id: 1,
        title: "Новые технологии искусственного интеллекта",
        body: "Исследователи представили новую модель ИИ, способную понимать контекст и генерировать тексты на естественном языке. Технология открывает новые возможности для автоматизации контента.",
        category: "технологии"
    },
    {
        id: 2,
        title: "Чемпионат мира по футболу 2024",
        body: "Национальная сборная показала блестящую игру в матче с фаворитом турнира. Игроки демонстрируют отличную физическую подготовку и тактическое понимание.",
        category: "спорт"
    },
    {
        id: 3,
        title: "Экономический форум в Москве",
        body: "Ведущие экономисты обсуждают перспективы развития российской экономики. Особое внимание уделяется цифровизации и импортозамещению.",
        category: "бизнес"
    },
    {
        id: 4,
        title: "Реформа системы образования",
        body: "Министерство образования анонсировало изменения в учебных программах. Акцент будет сделан на практических навыках и цифровой грамотности.",
        category: "наука"
    },
    {
        id: 5,
        title: "Выставка современного искусства",
        body: "В главном музее страны открылась масштабная выставка современных художников. Экспозиция включает интерактивные инсталляции и цифровое искусство.",
        category: "культура"
    },
    {
        id: 6,
        title: "Развитие квантовых вычислений",
        body: "Российские ученые достигли прорыва в создании квантовых процессоров. Новые технологии обещают революцию в области шифрования и моделирования.",
        category: "технологии"
    },
    {
        id: 7,
        title: "Теннисный турнир Большого шлема",
        body: "Российская теннисистка вышла в полуфинал престижного турнира. Её игра восхищает зрителей и экспертов своим стилем и техникой.",
        category: "спорт"
    },
    {
        id: 8,
        title: "Международные санкции и экономика",
        body: "Эксперты анализируют влияние санкций на различные сектора экономики. Обсуждаются пути адаптации и поиска новых рынков.",
        category: "политика"
    },
    {
        id: 9,
        title: "Открытие новой экзопланеты",
        body: "Астрономы обнаружили планету в зоне обитаемости далекой звезды. Открытие приближает человечество к поиску внеземной жизни.",
        category: "наука"
    },
    {
        id: 10,
        title: "Театральный фестиваль 'Золотая маска'",
        body: "В столице начался крупнейший театральный фестиваль страны. В программе представлены лучшие постановки со всех регионов России.",
        category: "культура"
    },
    {
        id: 11,
        title: "Кибербезопасность и защита данных",
        body: "Специалисты предупреждают о новых видах кибератак. Разрабатываются современные методы защиты персональной информации.",
        category: "технологии"
    },
    {
        id: 12,
        title: "Хоккейный матч чемпионата",
        body: "Дерби между старейшими клубами завершилось вничью. Обе команды показали высочайший уровень мастерства и волю к победе.",
        category: "спорт"
    },
    {
        id: 13,
        title: "Инвестиции в стартапы",
        body: "Венчурные фонды увеличивают финансирование технологических стартапов. Особый интерес вызывают проекты в области биотехнологий.",
        category: "бизнес"
    },
    {
        id: 14,
        title: "Дипломатические переговоры",
        body: "Состоялась встреча министров иностранных дел для обсуждения актуальных международных вопросов. Стороны выразили готовность к диалогу.",
        category: "политика"
    },
    {
        id: 15,
        title: "Археологическая находка",
        body: "Ученые обнаружили древнее поселение при раскопках в Сибири. Находка проливает свет на историю заселения региона.",
        category: "наука"
    },
    {
        id: 16,
        title: "Кинофестиваль в Сочи",
        body: "Открылся международный кинофестиваль с участием звезд мирового кинематографа. В конкурсной программе представлены фильмы из 30 стран.",
        category: "культура"
    },
    {
        id: 17,
        title: "Разработка отечественного ПО",
        body: "Российские компании представляют новые программные решения для бизнеса. Акцент делается на безопасность и импортозамещение.",
        category: "технологии"
    },
    {
        id: 18,
        title: "Легкоатлетические соревнования",
        body: "Спортсмены установили несколько рекордов на национальном чемпионате. Результаты позволяют надеяться на успех на международной арене.",
        category: "спорт"
    },
    {
        id: 19,
        title: "Цифровая трансформация бизнеса",
        body: "Крупные компании внедряют современные технологии для оптимизации процессов. Цифровизация позволяет снизить издержки и повысить эффективность.",
        category: "бизнес"
    },
    {
        id: 20,
        title: "Климатический саммит",
        body: "Мировые лидеры обсуждают меры по борьбе с изменением климата. Особое внимание уделяется переходу на зеленую энергетику.",
        category: "политика"
    }
];

// Конфигурация
const КЛЮЧ_КЭША = 'новостной_кэш';
const ВРЕМЯ_ЖИЗНИ_КЭША = 5 * 60 * 1000; // 5 минут
const КОЛИЧЕСТВО_ПОВТОРОВ = 3;
const ТАЙМАУТ_ЗАПРОСА = 5000;
const РАЗМЕР_СТРАНИЦЫ = 6;

// Состояние приложения
const состояние = {
    новости: [],
    отфильтрованныеНовости: [],
    текущаяСтраница: 1,
    идетЗагрузка: false,
    текущийЗапрос: null,
    кэш: {
        данные: [],
        меткаВремени: 0,
        сохраненныеЗапросы: 0
    }
};

// DOM элементы
const элементы = {
    поиск: document.getElementById('search'),
    категория: document.getElementById('category'),
    кнопкаЗагрузки: document.getElementById('load'),
    кнопкаОбновления: document.getElementById('refresh'),
    кнопкаОтмены: document.getElementById('cancel'),
    кнопкаПовтора: document.getElementById('retry'),
    кнопкаОчисткиКэша: document.getElementById('clear-cache'),
    индикаторЗагрузки: document.getElementById('loading'),
    блокОшибки: document.getElementById('error'),
    текстОшибки: document.getElementById('error-text'),
    блокПусто: document.getElementById('empty'),
    сеткаНовостей: document.getElementById('news-grid'),
    кнопкаНазад: document.getElementById('prev'),
    кнопкаВперед: document.getElementById('next'),
    инфоСтраницы: document.getElementById('page-info'),
    счетчикКэша: document.getElementById('cache-count'),
    счетчикСохранений: document.getElementById('cache-saved')
};

// Цвета категорий
const цветаКатегорий = {
    'технологии': '#4361ee',
    'спорт': '#4cc9f0',
    'политика': '#7209b7',
    'бизнес': '#f8961e',
    'наука': '#38b000',
    'культура': '#ff5d8f'
};

/**
 * Инициализация приложения
 */
function инициализировать() {
    загрузитьКэш();
    настроитьОбработчикиСобытий();
    обновитьСтатистикуКэша();
    загрузитьНовости(false).catch(обработатьОшибку);
}

/**
 * Загружает кэш из localStorage
 */
function загрузитьКэш() {
    try {
        const кэшированныеДанные = localStorage.getItem(КЛЮЧ_КЭША);
        if (кэшированныеДанные) {
            const данныеКэша = JSON.parse(кэшированныеДанные);
            // Проверяем, не истек ли кэш
            if (Date.now() - данныеКэша.меткаВремени < ВРЕМЯ_ЖИЗНИ_КЭША) {
                состояние.кэш = данныеКэша;
            }
        }
    } catch (ошибка) {
        // eslint-disable-next-line no-console
        console.warn('Не удалось загрузить кэш:', ошибка);
    }
}

/**
 * Сохраняет кэш в localStorage
 */
function сохранитьКэш() {
    try {
        localStorage.setItem(КЛЮЧ_КЭША, JSON.stringify(состояние.кэш));
    } catch (ошибка) {
        // eslint-disable-next-line no-console
        console.warn('Не удалось сохранить кэш:', ошибка);
    }
}

/**
 * Обновляет статистику кэша в UI
 */
function обновитьСтатистикуКэша() {
    элементы.счетчикКэша.textContent = состояние.кэш.данные.length;
    элементы.счетчикСохранений.textContent = состояние.кэш.сохраненныеЗапросы;
}

/**
 * Имитирует запрос к API с задержкой
 * @param {boolean} сОшибкой - Имитировать ошибку
 * @returns {Promise<Array>} - Данные новостей
 */
async function имитироватьЗапросAPI(сОшибкой = false) {
    return new Promise((разрешить, отклонить) => {
        setTimeout(() => {
            if (сОшибкой) {
                отклонить(new Error('Сервер временно недоступен'));
            } else {
                разрешить([...РУССКИЕ_НОВОСТИ]);
            }
        }, 1000); // Имитация задержки сети
    });
}

/**
 * Выполняет запрос с повторными попытками
 * @param {boolean} игнорироватьКэш - Игнорировать кэш
 * @param {AbortSignal} сигнал - Сигнал для отмены
 * @returns {Promise<Array>} - Данные новостей
 */
async function выполнитьЗапросСПовторами(игнорироватьКэш = false, сигнал = null) {
    // Проверка кэша
    if (!игнорироватьКэш && состояние.кэш.данные.length > 0) {
        состояние.кэш.сохраненныеЗапросы += 1;
        сохранитьКэш();
        обновитьСтатистикуКэша();
        return состояние.кэш.данные;
    }

    let последняяОшибка;

    for (let попытка = 0; попытка < КОЛИЧЕСТВО_ПОВТОРОВ; попытка += 1) {
        try {
            const контроллер = new AbortController();
            состояние.текущийЗапрос = контроллер;
            элементы.кнопкаОтмены.disabled = false;

            if (сигнал) {
                сигнал.addEventListener('abort', () => контроллер.abort());
            }

            // Таймаут
            const таймаут = setTimeout(() => контроллер.abort(), ТАЙМАУТ_ЗАПРОСА);

            // Имитация запроса к API (в 20% случаев с ошибкой для демонстрации ретраев)
            const сОшибкой = Math.random() < 0.2 && попытка < КОЛИЧЕСТВО_ПОВТОРОВ - 1;
            const данные = await имитироватьЗапросAPI(сОшибкой);

            clearTimeout(таймаут);

            // Обновляем кэш
            состояние.кэш = {
                данные,
                меткаВремени: Date.now(),
                сохраненныеЗапросы: состояние.кэш.сохраненныеЗапросы
            };
            сохранитьКэш();
            обновитьСтатистикуКэша();

            состояние.текущийЗапрос = null;
            элементы.кнопкаОтмены.disabled = true;

            return данные;

        } catch (ошибка) {
            последняяОшибка = ошибка;

            if (ошибка.name === 'AbortError') {
                throw ошибка;
            }

            // Пауза перед повторной попыткой (экспоненциальная задержка)
            if (попытка < КОЛИЧЕСТВО_ПОВТОРОВ - 1) {
                const задержка = Math.min(1000 * (2 ** попытка), 10000);
                await new Promise((разрешить) => setTimeout(разрешить, задержка));
                показатьУведомление(`Повторная попытка ${попытка + 2}/${КОЛИЧЕСТВО_ПОВТОРОВ}...`, 'info');
            }
        }
    }

    throw последняяОшибка;
}

/**
 * Загружает новости
 * @param {boolean} игнорироватьКэш - Игнорировать кэш
 * @returns {Promise<void>}
 */
async function загрузитьНовости(игнорироватьКэш = false) {
    if (состояние.идетЗагрузка) {
        return;
    }

    try {
        состояние.идетЗагрузка = true;
        обновитьСостояниеUI('загрузка');

        const контроллер = new AbortController();
        const данные = await выполнитьЗапросСПовторами(игнорироватьКэш, контроллер.signal);

        состояние.новости = данные;
        отфильтроватьНовости();
        отобразитьНовости();
        обновитьСостояниеUI('успех');
        показатьУведомление('Новости успешно загружены!', 'success');

    } catch (ошибка) {
        if (ошибка.name !== 'AbortError') {
            обработатьОшибку(ошибка);
        }
    } finally {
        состояние.идетЗагрузка = false;
        состояние.текущийЗапрос = null;
        элементы.кнопкаОтмены.disabled = true;
    }
}

/**
 * Обрабатывает ошибки
 * @param {Error} ошибка - Ошибка
 */
function обработатьОшибку(ошибка) {
    // eslint-disable-next-line no-console
    console.error('Ошибка загрузки:', ошибка);
    
    let сообщениеОбОшибке;
    
    if (ошибка.name === 'AbortError') {
        сообщениеОбОшибке = 'Запрос был отменен';
    } else if (ошибка.message.includes('timeout')) {
        сообщениеОбОшибке = 'Превышено время ожидания ответа от сервера';
    } else if (ошибка.message.includes('network')) {
        сообщениеОбОшибке = 'Проблемы с сетевым подключением';
    } else {
        сообщениеОбОшибке = ошибка.message || 'Не удалось загрузить новости';
    }
    
    элементы.текстОшибки.textContent = сообщениеОбОшибке;
    обновитьСостояниеUI('ошибка');
    показатьУведомление(сообщениеОбОшибке, 'error');
}

/**
 * Фильтрует новости по поиску и категории
 */
function отфильтроватьНовости() {
    const поисковыйЗапрос = элементы.поиск.value.toLowerCase();
    const выбраннаяКатегория = элементы.категория.value;

    состояние.отфильтрованныеНовости = состояние.новости.filter((новость) => {
        const совпадениеПоПоиску = !поисковыйЗапрос
            || новость.title.toLowerCase().includes(поисковыйЗапрос)
            || новость.body.toLowerCase().includes(поисковыйЗапрос);

        const совпадениеПоКатегории = !выбраннаяКатегория || новость.category === выбраннаяКатегория;

        return совпадениеПоПоиску && совпадениеПоКатегории;
    });

    состояние.текущаяСтраница = 1;
    обновитьПагинацию();
}

/**
 * Отображает новости в сетке
 */
function отобразитьНовости() {
    элементы.сеткаНовостей.innerHTML = '';

    const начальныйИндекс = (состояние.текущаяСтраница - 1) * РАЗМЕР_СТРАНИЦЫ;
    const конечныйИндекс = начальныйИндекс + РАЗМЕР_СТРАНИЦЫ;
    const новостиНаСтранице = состояние.отфильтрованныеНовости.slice(начальныйИндекс, конечныйИндекс);

    if (новостиНаСтранице.length === 0) {
        обновитьСостояниеUI('пусто');
        return;
    }

    новостиНаСтранице.forEach((новость) => {
        const карточка = document.createElement('article');
        карточка.className = 'news-card';
        карточка.setAttribute('role', 'listitem');
        карточка.setAttribute('aria-label', `Новость: ${новость.title}`);

        const цвет = цветаКатегорий[новость.category] || '#4361ee';
        const иконкиКатегорий = {
            'технологии': 'fas fa-microchip',
            'спорт': 'fas fa-futbol',
            'политика': 'fas fa-landmark',
            'бизнес': 'fas fa-chart-line',
            'наука': 'fas fa-flask',
            'культура': 'fas fa-theater-masks'
        };
        const иконка = иконкиКатегорий[новость.category] || 'fas fa-newspaper';

        // Используем createElement вместо innerHTML для безопасности
        const изображение = document.createElement('div');
        изображение.className = 'news-image';
        изображение.style.background = `linear-gradient(135deg, ${цвет}, #764ba2)`;
        
        const иконкаЭлемент = document.createElement('i');
        иконкаЭлемент.className = иконка;
        иконкаЭлемент.setAttribute('aria-hidden', 'true');
        изображение.appendChild(иконкаЭлемент);

        const контент = document.createElement('div');
        контент.className = 'news-content';

        const заголовок = document.createElement('h3');
        заголовок.className = 'news-title';
        заголовок.textContent = новость.title;

        const текст = document.createElement('p');
        текст.className = 'news-body';
        текст.textContent = `${новость.body.substring(0, 120)}...`;

        const футер = document.createElement('div');
        футер.className = 'news-footer';

        const категория = document.createElement('span');
        категория.className = 'news-category';
        категория.style.background = цвет;
        категория.textContent = новость.category;

        const id = document.createElement('span');
        id.className = 'news-id';
        id.textContent = `ID: ${новость.id}`;

        футер.appendChild(категория);
        футер.appendChild(id);

        контент.appendChild(заголовок);
        контент.appendChild(текст);
        контент.appendChild(футер);

        карточка.appendChild(изображение);
        карточка.appendChild(контент);

        элементы.сеткаНовостей.appendChild(карточка);
    });
}

/**
 * Обновляет состояние UI
 * @param {string} состояниеUI - Название состояния
 */
function обновитьСостояниеUI(состояниеUI) {
    элементы.индикаторЗагрузки.classList.toggle('hidden', состояниеUI !== 'загрузка');
    элементы.блокОшибки.classList.toggle('hidden', состояниеUI !== 'ошибка');
    элементы.блокПусто.classList.toggle('hidden', состояниеUI !== 'пусто');

    элементы.кнопкаЗагрузки.disabled = состояниеUI === 'загрузка';
    элементы.кнопкаОбновления.disabled = состояниеUI === 'загрузка';
}

/**
 * Обновляет пагинацию
 */
function обновитьПагинацию() {
    const всегостраниц = Math.ceil(состояние.отфильтрованныеНовости.length / РАЗМЕР_СТРАНИЦЫ);

    элементы.кнопкаНазад.disabled = состояние.текущаяСтраница === 1;
    элементы.кнопкаВперед.disabled = состояние.текущаяСтраница === всегостраниц;
    элементы.инфоСтраницы.textContent = `Страница ${состояние.текущаяСтраница} из ${всегостраниц}`;
}

/**
 * Показывает уведомление
 * @param {string} сообщение - Сообщение
 * @param {string} тип - Тип уведомления (success, error, info)
 */
function показатьУведомление(сообщение, тип = 'info') {
    // Удаляем предыдущее уведомление
    const староеУведомление = document.querySelector('.notification');
    if (староеУведомление) {
        староеУведомление.remove();
    }

    const уведомление = document.createElement('div');
    уведомление.className = `notification ${тип}`;
    уведомление.textContent = сообщение;
    
    document.body.appendChild(уведомление);
    
    setTimeout(() => {
        if (уведомление.parentNode) {
            уведомление.remove();
        }
    }, 3000);
}

/**
 * Настраивает обработчики событий
 */
function настроитьОбработчикиСобытий() {
    // Загрузка новостей
    элементы.кнопкаЗагрузки.addEventListener('click', () => {
        загрузитьНовости(false).catch(обработатьОшибку);
    });

    // Обновление (игнорировать кэш)
    элементы.кнопкаОбновления.addEventListener('click', () => {
        загрузитьНовости(true).catch(обработатьОшибку);
    });

    // Отмена запроса
    элементы.кнопкаОтмены.addEventListener('click', () => {
        if (состояние.текущийЗапрос) {
            состояние.текущийЗапрос.abort();
            состояние.текущийЗапрос = null;
            элементы.кнопкаОтмены.disabled = true;
            обновитьСостояниеUI('готово');
            показатьУведомление('Запрос отменен', 'info');
        }
    });

    // Повтор при ошибке
    элементы.кнопкаПовтора.addEventListener('click', () => {
        загрузитьНовости(false).catch(обработатьОшибку);
    });

    // Фильтрация
    элементы.поиск.addEventListener('input', () => {
        отфильтроватьНовости();
        отобразитьНовости();
    });

    элементы.категория.addEventListener('change', () => {
        отфильтроватьНовости();
        отобразитьНовости();
    });

    // Пагинация
    элементы.кнопкаНазад.addEventListener('click', () => {
        if (состояние.текущаяСтраница > 1) {
            состояние.текущаяСтраница -= 1;
            отобразитьНовости();
            обновитьПагинацию();
        }
    });

    элементы.кнопкаВперед.addEventListener('click', () => {
        const всегостраниц = Math.ceil(состояние.отфильтрованныеНовости.length / РАЗМЕР_СТРАНИЦЫ);
        if (состояние.текущаяСтраница < всегостраниц) {
            состояние.текущаяСтраница += 1;
            отобразитьНовости();
            обновитьПагинацию();
        }
    });

    // Очистка кэша
    элементы.кнопкаОчисткиКэша.addEventListener('click', () => {
        состояние.кэш = { данные: [], меткаВремени: 0, сохраненныеЗапросы: 0 };
        сохранитьКэш();
        обновитьСтатистикуКэша();
        показатьУведомление('Кэш успешно очищен', 'success');
    });

    // Автозагрузка при фокусе на поиске
    элементы.поиск.addEventListener('focus', () => {
        if (состояние.новости.length === 0) {
            загрузитьНовости(false).catch(обработатьОшибку);
        }
    });
}

// Запуск приложения
document.addEventListener('DOMContentLoaded', инициализировать);