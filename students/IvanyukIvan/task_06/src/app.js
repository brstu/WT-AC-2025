const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
require('dotenv').config();

const authRoutes = require('./routes/auth.routes');
const wordsRoutes = require('./routes/words.routes');
const { prisma } = require('./models');

const app = express();
const PORT = process.env.PORT || 3000;

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° CORS
app.use(cors({
  origin: process.env.CORS_ORIGIN || '*',
  credentials: true
}));

// Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Helmet
app.use(helmet());

// Ð›Ð¸Ð¼Ð¸Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
const limiter = rateLimit({
  windowMs: parseInt(process.env.RATE_LIMIT_WINDOW_MS) || 900000, // 15 Ð¼Ð¸Ð½ÑƒÑ‚
  max: parseInt(process.env.RATE_LIMIT_MAX) || 100,
  message: 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ ÑÑ‚Ð¾Ð³Ð¾ IP, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ'
});
app.use('/api/', limiter);

// ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ JSON
app.use(express.json({ limit: process.env.MAX_BODY_SIZE || '10mb' }));

// ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ URL-encoded
app.use(express.urlencoded({ extended: true, limit: process.env.MAX_BODY_SIZE || '10mb' }));

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
app.use('/api/auth', authRoutes);
app.use('/api/words', wordsRoutes);

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ API
app.get('/api/health', (req, res) => {
  res.json({
    success: true,
    message: 'Language Tracker API Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚',
    timestamp: new Date().toISOString()
  });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° 404
app.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    message: 'ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½'
  });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
app.use((err, req, res, next) => {
  console.error('Server error:', err);
  
  res.status(err.status || 500).json({
    success: false,
    message: process.env.NODE_ENV === 'development' 
      ? err.message 
      : 'Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const startServer = async () => {
  try {
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð”
    await prisma.$connect();
    console.log('âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾');

    app.listen(PORT, () => {
      console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
      console.log(`ðŸ“š API Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ http://localhost:${PORT}/api`);
    });
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ ÑÐµÑ€Ð²ÐµÑ€Ð°:', error);
    process.exit(1);
  }
};

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ
process.on('SIGINT', async () => {
  await prisma.$disconnect();
  console.log('âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¾');
  process.exit(0);
});

startServer();